# =============================================================================
# PRODUCTION COMPOSE - Budget Tracker
# Deploy with: docker stack deploy -c compose.yaml budget-tracker
# =============================================================================

services:
  # Main Application
  app:
    image: as3305100/budget-tracker:latest
    deploy:
      replicas: 1
      update_config:
        order: start-first
        failure_action: rollback
        delay: 10s
      rollback_config:
        parallelism: 1
        order: start-first
    healthcheck:
      test:
        - CMD
        - wget
        - "--no-verbose"
        - "--tries=1"
        - "--spider"
        - http://127.0.0.1:3000/health/live
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 1m
    environment:
      # Server
      - PORT=3000
      - NODE_ENV=production
      - CLIENT_URL=https://your-frontend-domain.com
      - APP_URL=https://your-api-domain.com
      # Auth
      - ACCESS_TOKEN_EXPIRY=15m
      - REFRESH_TOKEN_EXPIRY=7d
      - SALT_ROUNDS=10
      # SMTP
      - SMTP_HOST=smtp.gmail.com
      - SMTP_PORT=587
      # Secrets (loaded from Docker secrets)
      - DATABASE_URL_FILE=/run/secrets/database_url
      - ACCESS_TOKEN_SECRET_FILE=/run/secrets/access_token_secret
      - REFRESH_TOKEN_SECRET_FILE=/run/secrets/refresh_token_secret
      - SMTP_USER_FILE=/run/secrets/smtp_user
      - SMTP_PASS_FILE=/run/secrets/smtp_pass
      - GOOGLE_CLIENT_ID_FILE=/run/secrets/google_client_id
      - GOOGLE_CLIENT_SECRET_FILE=/run/secrets/google_client_secret
      - GOOGLE_CALLBACK_URL_FILE=/run/secrets/google_callback_url_v2
      - RAZORPAY_KEY_ID_FILE=/run/secrets/razorpay_key_id
      - RAZORPAY_KEY_SECRET_FILE=/run/secrets/razorpay_key_secret
      - RAZORPAY_WEBHOOK_SECRET_FILE=/run/secrets/razorpay_webhook_secret
      - AWS_REGION_FILE=/run/secrets/aws_region
      - AWS_ACCESS_KEY_ID_FILE=/run/secrets/aws_access_key_id
      - AWS_SECRET_ACCESS_KEY_FILE=/run/secrets/aws_secret_access_key
      - AWS_S3_BUCKET_NAME_FILE=/run/secrets/aws_s3_bucket_name
      - REDIS_URL_FILE=/run/secrets/redis_url
    networks:
      - budget_net
    secrets:
      - database_url
      - access_token_secret
      - refresh_token_secret
      - smtp_user
      - smtp_pass
      - google_client_id
      - google_client_secret
      - google_callback_url
      - razorpay_key_id
      - razorpay_key_secret
      - razorpay_webhook_secret
      - aws_region
      - aws_access_key_id
      - aws_secret_access_key
      - aws_s3_bucket_name
      - redis_url

  # Reverse Proxy
  caddy:
    image: caddy:2-alpine
    deploy:
      replicas: 1
      update_config:
        order: start-first
        failure_action: rollback
        delay: 10s
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - budget_net
    configs:
      - source: Caddyfile
        target: /etc/caddy/Caddyfile

networks:
  budget_net:

volumes:
  caddy_data:
  caddy_config:

secrets:
  database_url:
    external: true
  access_token_secret:
    external: true
  refresh_token_secret:
    external: true
  smtp_user:
    external: true
  smtp_pass:
    external: true
  google_client_id:
    external: true
  google_client_secret:
    external: true
  google_callback_url_v2:
    external: true
  razorpay_key_id:
    external: true
  razorpay_key_secret:
    external: true
  razorpay_webhook_secret:
    external: true
  aws_region:
    external: true
  aws_access_key_id:
    external: true
  aws_secret_access_key:
    external: true
  aws_s3_bucket_name:
    external: true
  redis_url:
    external: true

configs:
  Caddyfile:
    file: ./Caddyfile
