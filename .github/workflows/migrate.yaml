name: Run Migrations

on:
  push:
    branches: [main]

# Environment variables for Prisma (non-DB related)
env:
  NODE_ENV: production
  PORT: 3000
  CLIENT_URL: http://localhost:3000
  ACCESS_TOKEN_SECRET: dummy
  REFRESH_TOKEN_SECRET: dummy
  ACCESS_TOKEN_EXPIRY: 15m
  REFRESH_TOKEN_EXPIRY: 7d
  SMTP_HOST: smtp.example.com
  SMTP_PORT: 587
  SMTP_USER: test@example.com
  SMTP_PASS: dummy
  REDIS_PORT: 6379
  REDIS_HOST: localhost
  SALT_ROUNDS: 10
  APP_URL: http://localhost:3000
  FORGOT_PASSWORD_REDIRECT_URL: http://localhost:3000/reset-password
  GOOGLE_CLIENT_ID: dummy
  GOOGLE_CLIENT_SECRET: dummy
  GOOGLE_CALLBACK_URL: http://localhost:3000/auth/google/callback
  RAZORPAY_KEY_ID: dummy
  RAZORPAY_KEY_SECRET: dummy
  RAZORPAY_WEBHOOK_SECRET: dummy
  AWS_REGION: us-east-1
  AWS_ACCESS_KEY_ID: dummy
  AWS_SECRET_ACCESS_KEY: dummy
  AWS_S3_BUCKET_NAME: dummy

jobs:
  migrate-dev:
    name: Migrate Development Database
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}

      - name: Run Prisma migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}

      - name: Verify migration status
        run: npx prisma migrate status
        env:
          DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}

  migrate-production:
    name: Migrate Production Database
    runs-on: ubuntu-latest
    needs: migrate-dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}

      - name: Run Prisma migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}

      - name: Verify database health
        run: |
          npx prisma db pull
          echo "Production database migrated successfully!"
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
